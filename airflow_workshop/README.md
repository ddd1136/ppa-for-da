* Создайте виртуальное окружение и активируйте его:
```shell script
python3 -m venv venv
```

* Активируйте его:
```shell script
source venv/bin/activate
```
или в Windowns
```shell script
source venv/Scripts/activate
```

* Обновите pip до последней версии:
```shell script
pip install --upgrade pip
```
* Установите зависимости:
```shell script
pip install -r requirements.txt
```

Для выполнения заданий выполните:

`docker compose up -d`

Если у Вас не установлен python 3.8 то самое время сделать это. 

- Airflow
	- `localhost:3000/airflow`
- БД
	- `jovyan:jovyan@localhost:15432/de`
	- в Airflow порт 5432
- Metabase
    - `http://localhost:3333/` 

## Начало работы

Подключитесь в dockere к Postrges и создайте модель для stg-слоя (пример скрипта sql/stg_ddl.sql)

Через Airflow UI (AirflowAdmin : airflow_pass) создайте подключение к БД (admin - connections), назовите его PG_WAREHOUSE_CONNECTION (как в скрипте dags/get_data.py).

Запустите dag get_data и убедитесь в том, что dag завершен успешно.

## Задание 2 оп курсу "Прикладные пакеты для анализа данных" 

Задание делается в группах по 3-5 человек

1) Построить пайплайн средствами Airflow для подготовки данных для дэшбордов. Данные для дэшборда должны находиться в слое cdm и формироваться только по данным из слоя dds.

Требования к дэшборду:
- доля учебных планов в статусе "одобрено" (только для 2023 и 2024 года),
- доля/количество учебных планов с некорректной трудоемкостью (только для 2023 и 2024 года, корректная трудоемкость у бакалавров - 240, а магистров - 120),
- доля заполненных аннотаций в динамике,
- долю дисциплин в статусе "одобрено" в динамике,

Данные необходимо отображать в разрезах:
- - ОП (с учетом года), 
- - структурных подразделений для дисциплин, 
- - уровней образования (бакалавр, специалист, магистр),
- - структурных подразделений для ОП, 
- - редактор (для РПД),
- - учебного года (текущий и следующий).

2) Построить дэшборд средствами Metabase (есть в сборке). Возможна выгрузка таблиц из слоя cdm и дальнейшее построение дэшборда другими средствами


Здесь описан один из возможных вариантов выполнения: 
- доработайте модель на слое stg с учетом эндпойнтов для получения информации о структурных подразделениях и статусах, а также с учетом json'ов c учебными планами;
- доработайте модель на stg с учетом SCD2 (https://en.wikipedia.org/wiki/Slowly_changing_dimension);
- доработайте скрипт из dag'а get_data для сбора данных по всем эндпойнтам;
- доработайте модель данных для слоя dds, учивающую все необходимые поля для построения дэшборда;
- создайте скрипт для переноса данных из stg на dds;
- спроектируйте модель для cdm (слой витрин);
- подключите Metabase к модели на слое cdm (при первом подключении нужно зарегистрироваться, хост:порт de-pg-cr-af:5432);
- сформируйте дэшборд в соответствии с требованиями.


## Эндпойнты
- Структные подразделения: https://op.itmo.ru/api/record/structural/workprogram (см. dags/get_data.py)
- Рабочие программы и статусы: https://op.itmo.ru/api/record/academic_plan/academic_wp_description/all (см. dag/get_data.py)
- Рабочие программы ипо годам https://op.itmo.ru/api/record/academicplan/get_wp_by_year/ - (см. dag/get_disc_by_year.py)
- Учебные планы из конструктора ОП: https://op.itmo.ru/api/academicplan/detail/ - (см. dag/get_up_detail.py)

## Замечание по поводу проектирования слоёв
Staging — первый слой в хранилище. Это значит, что данные из систем-источников сначала попадают именно в него. Основные функции staging-области:
- Сбор сырых данных из нескольких источников 
- Снятие нагрузки с систем-источников 

С какого слоя начать проектирование? Определиться с порядком создания слоёв помогут концепции Ральфа Кимбалла и Билла Инмона о проектировании корпоративных хранилищ данных. Принципиальное отличие подходов в том, что считать более важным. Эти подходы часто сравнивают, но в реальности в чистом виде их используют очень редко, поэтому проще каждый раз отталкиваться от задачи.

### Подход Ральфа Кимбалла
Кимбалл говорит, что важнее всего — потребности бизнеса, а значит, проектирование нужно осуществлять начиная с витрин. Всё остальное хранилище должно быть нацелено на их обслуживание.
В первую очередь вы должны выяснить у заказчика, какие витрины и с какими показателями нужны. Спроектировав и задокументировав витрины, вы можете начать работу с детальным слоем, который будет хранить только данные, необходимые для обслуживания витрин.

Преимущества метода:
- Быстрая реализация, так как исходим от конкретных потребностей бизнеса.
- Используется простая, понятная и эффективная модель «звезда», когда это возможно.
- Поддерживать работу хранилища данных сможет небольшое количество специалистов.

Недостатки метода:
- Нет единого источника истинной информации, потому что данные интегрированы, то есть связаны между собой, не полностью.
- Добавление столбцов в таблицу фактов может снизить эффективность — придётся перестраивать таблицу, чтобы удовлетворить требованиям модели данных, и таблица будет перегружена.
- Хранилище не удовлетворяет запросам всей компании, потому что изначально было ориентировано на конкретные бизнес-процессы.

### Подход Билла Инмона
В подходе Билла Инмона важнее корпоративная модель данных. Сперва мы должны определить предметные области бизнеса и спроектировать хранилище, которое полностью их описывает. При таком подходе сначала строится нормализованная модель данных и уже на её основе — витрины.

Преимущества метода:
- DDS — единственный источник данных для витрин, а также корректной информации для компании.
- Все данные в хранилище интегрированы.
- Понятная последовательность этапов в бизнес-процессах, поскольку они изображены подробно.
- Возможность составлять разнообразные отчёты в зависимости от требований.

Недостатки метода:
- Более сложная модель данных.
- Компании необходима компетенция в моделировании данных, это сложная и дорогостоящая задача.
- Первоначальная настройка занимает продолжительное время.
- Дополнительная работа с ETL-процессом.
- Чтобы поддерживать работу хранилища, нужно большое количество специалистов.
